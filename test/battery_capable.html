<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <script src="../bower_components/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>
  <script type="module" src="hui-view-mock.js"></script>
  <script type="module" src="../power-wheel-card.js"></script>
</head>
<body>
<test-fixture id="simple">
  <template>
    <power-wheel-card></power-wheel-card>
  </template>
</test-fixture>
<script>
  suite('<power-wheel-card> with battery', () => {
    let card, hass, config;

    /** Tests are based on basic_config. **/

    setup(() => {
      card = fixture('simple');
      config = {
        type: "custom:power-wheel-card",
        solar_power_entity: "sensor.solar_power",
        grid_power_consumption_entity: "sensor.grid_power_consumption",
        grid_power_production_entity: "sensor.grid_power_production",
        battery_power_entity: "sensor.battery_power",
        color_icons: false,
      };
      hass = {
        // Battery, Grid and Solar are delivering to Home
        states: {
          "sensor.solar_power" : {
            attributes: {
              unit_of_measurement: "W",
              friendly_name: "Solar Power",
            },
            entity_id: "sensor.solar_power",
            state: "500",
          },
          "sensor.grid_power_consumption" : {
            attributes: {
              unit_of_measurement: "W",
            },
            entity_id: "sensor.grid_power_consumption",
            state: "1800",
          },
          "sensor.grid_power_production" : {
            attributes: {
              unit_of_measurement: "W",
            },
            entity_id: "sensor.grid_power_production",
            state: "0",
          },
          "sensor.battery_power" : {
            attributes: {
              unit_of_measurement: "W",
            },
            entity_id: "sensor.battery_power",
            state: "-300",
          },
        },
      };
      card.setAttribute('hass', JSON.stringify(hass));
      card.setConfig(config);
    });

    const setCardProducingToGrid = () => {
      hass.states['sensor.grid_power_consumption'].state = "0";
      hass.states['sensor.grid_power_production'].state = "50";
      card.setAttribute('hass', JSON.stringify(hass));
    };

    const setCardAllInactive = () => {
      hass.states['sensor.solar_power'].state = "0";
      hass.states['sensor.grid_power_consumption'].state = "0";
      hass.states['sensor.grid_power_production'].state = "0";
      hass.states['sensor.battery_power'].state = "0";
      card.setAttribute('hass', JSON.stringify(hass));
    };

    const setCardBatteryChargedBySolar = () => {
      hass.states['sensor.battery_power'].state = "280";
      card.setAttribute('hass', JSON.stringify(hass));
    };

    const setCardBatteryChargedByGrid = () => {
      hass.states['sensor.solar_power'].state = "0";
      hass.states['sensor.battery_power'].state = "280";
      card.setAttribute('hass', JSON.stringify(hass));
    };

    test('has set card property values after setConfig', (done) => {
      flush(() => {
        assert.isTrue(card.views.power.batteryCapable, 'Card property views should have value set for power view battery capability');
        done();
      });
    });

    test('has ui elements', (done) => {
      flush(() => {
        assert.equal(card.shadowRoot.querySelector('#icon-battery').getAttribute('icon'), 'mdi:car-battery', 'Battery icon should be default icon');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2battery').getAttribute('icon'), 'mdi:arrow-right', 'Solar2Battery icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-battery2home').getAttribute('icon'), 'mdi:arrow-down', 'Battery2Home icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#cell-battery').getAttribute('title'), '', 'Battery title should be set');
        assert.equal(card.shadowRoot.querySelector('#cell-solar2battery').getAttribute('title'), 'More info', 'Solar2Battery title should be set');
        assert.equal(card.shadowRoot.querySelector('#cell-battery2home').getAttribute('title'), 'More info', 'Battery2Home title should be set');
        assert.equal(card.shadowRoot.querySelector('#cell-grid2battery'), undefined, 'Grid2Battery arrow should be disabled');
        done();
      });
    });

    test('displays values when consuming from solar, the grid and the battery', (done) => {
      flush(() => {
        assert.equal(card.shadowRoot.querySelector('#value-solar').innerText, '500', 'Solar should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-grid').innerText, '-1800', 'Grid should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-home').innerText, '-2600', 'Home should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-battery').innerText, '-300', 'Battery should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2grid').innerText, '', 'Solar2Grid arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2home').innerText, '', 'Solar2Home arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-grid2home').innerText, '', 'Grid2Home arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2battery').innerText, '', 'Solar2Battery arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-grid2battery'), undefined, 'Grid2Battery arrow shouldn\'t be there');
        assert.equal(card.shadowRoot.querySelector('#value-battery2home').innerText, '', 'Battery2Home arrow shouldn\'t have a value');
        done();
      });
    });

    test('has ui elements when consuming from solar, the grid and the battery', (done) => {
      flush(() => {
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar').classList.contains('producing'), 'Solar icon should be producing');
        assert.isTrue(card.shadowRoot.querySelector('#icon-grid').classList.contains('consuming'), 'Grid icon should be consuming');
        assert.isTrue(card.shadowRoot.querySelector('#icon-home').classList.contains('consuming'), 'Home icon should be consuming');
        assert.isTrue(card.shadowRoot.querySelector('#icon-battery').classList.contains('consuming'), 'Battery icon should be consuming');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2grid').getAttribute('icon'), 'mdi:arrow-bottom-left', 'Solar2Grid icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2home').getAttribute('icon'), 'mdi:arrow-bottom-right', 'Solar2Home icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-grid2home').getAttribute('icon'), 'mdi:arrow-right', 'Grid2Home icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2battery').getAttribute('icon'), 'mdi:arrow-right', 'Solar2Battery icon should be normal icon');
        // assert.equal(card.shadowRoot.querySelector('#icon-grid2battery').getAttribute('icon'), 'mdi:arrow-up', 'Grid2Battery icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-battery2home').getAttribute('icon'), 'mdi:arrow-down', 'Battery2Home icon should be normal icon');
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar2grid').classList.contains('inactive'), 'Solar2Grid arrow icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar2home').classList.contains('active'), 'Solar2Home arrow icon should be active');
        assert.isTrue(card.shadowRoot.querySelector('#icon-grid2home').classList.contains('active'), 'Grid2Home arrow icon should be active');
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar2battery').classList.contains('inactive'), 'Solar2Battery arrow icon should be inactive');
        // assert.isTrue(card.shadowRoot.querySelector('#icon-grid2battery').classList.contains('inactive'), 'Grid2Battery arrow icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-battery2home').classList.contains('active'), 'Battery2Home arrow icon should be active');
        done();
      });
    });

    test('displays values when producing to the grid while consuming from the battery', (done) => {
      setCardProducingToGrid();

      flush(() => {
        assert.equal(card.shadowRoot.querySelector('#value-solar').innerText, '500', 'Solar should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-grid').innerText, '50', 'Grid should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-home').innerText, '-750', 'Home should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-battery').innerText, '-300', 'Battery should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2grid').innerText, '', 'Solar2Grid arrow should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2home').innerText, '450', 'Solar2Home arrow should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-grid2home').innerText, '', 'Grid2Home arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2battery').innerText, '', 'Solar2Battery arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-grid2battery'), undefined, 'Grid2Battery arrow shouldn\'t be there');
        assert.equal(card.shadowRoot.querySelector('#value-battery2home').innerText, '', 'Battery2Home arrow shouldn\'t have a value');
        done();
      });
    });

    test('has ui elements when producing to the grid while consuming from the battery', (done) => {
      setCardProducingToGrid();

      flush(() => {
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar').classList.contains('producing'), 'Solar icon should be producing');
        assert.isTrue(card.shadowRoot.querySelector('#icon-grid').classList.contains('producing'), 'Grid icon should be producing');
        assert.isTrue(card.shadowRoot.querySelector('#icon-home').classList.contains('consuming'), 'Home icon should be consuming');
        assert.isTrue(card.shadowRoot.querySelector('#icon-battery').classList.contains('consuming'), 'Battery icon should be consuming');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2grid').getAttribute('icon'), 'mdi:arrow-bottom-left', 'Solar2Grid icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2home').getAttribute('icon'), 'mdi:arrow-bottom-right', 'Solar2Home icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-grid2home').getAttribute('icon'), 'mdi:arrow-right', 'Grid2Home icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2battery').getAttribute('icon'), 'mdi:arrow-right', 'Solar2Battery icon should be normal icon');
        // assert.equal(card.shadowRoot.querySelector('#icon-grid2battery').getAttribute('icon'), 'mdi:arrow-up', 'Grid2Battery icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-battery2home').getAttribute('icon'), 'mdi:arrow-down', 'Battery2Home icon should be normal icon');
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar2grid').classList.contains('active'), 'Solar2Grid arrow icon should be active');
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar2home').classList.contains('active'), 'Solar2Home arrow icon should be active');
        assert.isTrue(card.shadowRoot.querySelector('#icon-grid2home').classList.contains('inactive'), 'Grid2Home arrow icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar2battery').classList.contains('inactive'), 'Solar2Battery arrow icon should be inactive');
        // assert.isTrue(card.shadowRoot.querySelector('#icon-grid2battery').classList.contains('inactive'), 'Grid2Battery arrow icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-battery2home').classList.contains('active'), 'Battery2Home arrow icon should be active');
        done();
      });
    });

    test('displays values when all sensor values are zero', (done) => {
      setCardAllInactive();

      flush(() => {
        assert.equal(card.shadowRoot.querySelector('#value-solar').innerText, '0', 'Solar should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-grid').innerText, '0', 'Grid should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-home').innerText, '0', 'Home should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-battery').innerText, '0', 'Battery should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2grid').innerText, '', 'Solar2Grid arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2home').innerText, '', 'Solar2Home arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-grid2home').innerText, '', 'Grid2Home arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2battery'), undefined, 'Solar2Battery arrow shouldn\'t be there');
        assert.equal(card.shadowRoot.querySelector('#value-grid2battery').innerText, '', 'Grid2Battery arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-battery2home'), undefined, 'Battery2Home arrow shouldn\'t be there');
        done();
      });
    });

    test('has ui elements when all sensor values are zero', (done) => {
      setCardAllInactive();

      flush(() => {
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar').classList.contains('inactive'), 'Solar icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-grid').classList.contains('inactive'), 'Grid icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-home').classList.contains('inactive'), 'Home icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-battery').classList.contains('inactive'), 'Battery icon should be inactive');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2grid').getAttribute('icon'), 'mdi:arrow-bottom-left', 'Solar2Grid icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2home').getAttribute('icon'), 'mdi:arrow-bottom-right', 'Solar2Home icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-grid2home').getAttribute('icon'), 'mdi:arrow-right', 'Grid2Home icon should be normal icon');
        // assert.equal(card.shadowRoot.querySelector('#icon-solar2battery').getAttribute('icon'), 'mdi:arrow-right', 'Solar2Battery icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-grid2battery').getAttribute('icon'), 'mdi:arrow-up', 'Grid2Battery icon should be normal icon');
        // assert.equal(card.shadowRoot.querySelector('#icon-battery2home').getAttribute('icon'), 'mdi:arrow-down', 'Battery2Home icon should be normal icon');
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar2grid').classList.contains('inactive'), 'Solar2Grid arrow icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar2home').classList.contains('inactive'), 'Solar2Home arrow icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-grid2home').classList.contains('inactive'), 'Grid2Home arrow icon should be inactive');
        // assert.isTrue(card.shadowRoot.querySelector('#icon-solar2battery').classList.contains('inactive'), 'Solar2Battery arrow icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-grid2battery').classList.contains('inactive'), 'Grid2Battery arrow icon should be inactive');
        // assert.isTrue(card.shadowRoot.querySelector('#icon-battery2home').classList.contains('inactive'), 'Battery2Home arrow icon should be inactive');
        done();
      });
    });

    test('displays values when charging the battery by the sun while consuming from the grid', (done) => {
      setCardBatteryChargedBySolar();

      flush(() => {
        assert.equal(card.shadowRoot.querySelector('#value-solar').innerText, '500', 'Solar should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-grid').innerText, '-1800', 'Grid should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-home').innerText, '-2020', 'Home should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-battery').innerText, '280', 'Battery should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2grid').innerText, '', 'Solar2Grid arrow should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2home').innerText, '220', 'Solar2Home arrow should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-grid2home').innerText, '', 'Grid2Home arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2battery').innerText, '', 'Solar2Battery arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-grid2battery'), undefined, 'Grid2Battery arrow shouldn\'t be there');
        assert.equal(card.shadowRoot.querySelector('#value-battery2home').innerText, '', 'Battery2Home arrow shouldn\'t have a value');
        done();
      });
    });

    test('has ui elements when charging the battery by the sun while consuming from the grid', (done) => {
      setCardBatteryChargedBySolar();

      flush(() => {
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar').classList.contains('producing'), 'Solar icon should be producing');
        assert.isTrue(card.shadowRoot.querySelector('#icon-grid').classList.contains('consuming'), 'Grid icon should be consuming');
        assert.isTrue(card.shadowRoot.querySelector('#icon-home').classList.contains('consuming'), 'Home icon should be consuming');
        assert.isTrue(card.shadowRoot.querySelector('#icon-battery').classList.contains('producing'), 'Battery icon should be producing');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2grid').getAttribute('icon'), 'mdi:arrow-bottom-left', 'Solar2Grid icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2home').getAttribute('icon'), 'mdi:arrow-bottom-right', 'Solar2Home icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-grid2home').getAttribute('icon'), 'mdi:arrow-right', 'Grid2Home icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2battery').getAttribute('icon'), 'mdi:arrow-right', 'Solar2Battery icon should be normal icon');
        // assert.equal(card.shadowRoot.querySelector('#icon-grid2battery').getAttribute('icon'), 'mdi:arrow-up', 'Grid2Battery icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-battery2home').getAttribute('icon'), 'mdi:arrow-down', 'Battery2Home icon should be normal icon');
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar2grid').classList.contains('inactive'), 'Solar2Grid arrow icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar2home').classList.contains('active'), 'Solar2Home arrow icon should be active');
        assert.isTrue(card.shadowRoot.querySelector('#icon-grid2home').classList.contains('active'), 'Grid2Home arrow icon should be active');
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar2battery').classList.contains('active'), 'Solar2Battery arrow icon should be active');
        // assert.isTrue(card.shadowRoot.querySelector('#icon-grid2battery').classList.contains('inactive'), 'Grid2Battery arrow icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-battery2home').classList.contains('inactive'), 'Battery2Home arrow icon should be inactive');
        done();
      });
    });

    test('displays values when charging the battery by the grid', (done) => {
      setCardBatteryChargedByGrid();

      flush(() => {
        assert.equal(card.shadowRoot.querySelector('#value-solar').innerText, '0', 'Solar should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-grid').innerText, '-1800', 'Grid should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-home').innerText, '-1520', 'Home should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-battery').innerText, '280', 'Battery should have correct value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2grid').innerText, '', 'Solar2Grid arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2home').innerText, '', 'Solar2Home arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-grid2home').innerText, '', 'Grid2Home arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-solar2battery'), undefined, 'Solar2Battery arrow shouldn\'t be there');
        assert.equal(card.shadowRoot.querySelector('#value-grid2battery').innerText, '', 'Grid2Battery arrow shouldn\'t have a value');
        assert.equal(card.shadowRoot.querySelector('#value-battery2home'), undefined, 'Battery2Home arrow shouldn\'t be there');
        done();
      });
    });

    test('has ui elements when charging the battery by the grid', (done) => {
      setCardBatteryChargedByGrid();

      flush(() => {
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar').classList.contains('inactive'), 'Solar icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-grid').classList.contains('consuming'), 'Grid icon should be consuming');
        assert.isTrue(card.shadowRoot.querySelector('#icon-home').classList.contains('consuming'), 'Home icon should be consuming');
        assert.isTrue(card.shadowRoot.querySelector('#icon-battery').classList.contains('producing'), 'Battery icon should be producing');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2grid').getAttribute('icon'), 'mdi:arrow-bottom-left', 'Solar2Grid icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-solar2home').getAttribute('icon'), 'mdi:arrow-bottom-right', 'Solar2Home icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-grid2home').getAttribute('icon'), 'mdi:arrow-right', 'Grid2Home icon should be normal icon');
        // assert.equal(card.shadowRoot.querySelector('#icon-solar2battery').getAttribute('icon'), 'mdi:arrow-right', 'Solar2Battery icon should be normal icon');
        assert.equal(card.shadowRoot.querySelector('#icon-grid2battery').getAttribute('icon'), 'mdi:arrow-up', 'Grid2Battery icon should be normal icon');
        // assert.equal(card.shadowRoot.querySelector('#icon-battery2home').getAttribute('icon'), 'mdi:arrow-down', 'Battery2Home icon should be normal icon');
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar2grid').classList.contains('inactive'), 'Solar2Grid arrow icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-solar2home').classList.contains('inactive'), 'Solar2Home arrow icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-grid2home').classList.contains('active'), 'Grid2Home arrow icon should be active');
        // assert.isTrue(card.shadowRoot.querySelector('#icon-solar2battery').classList.contains('inactive'), 'Solar2Battery arrow icon should be inactive');
        assert.isTrue(card.shadowRoot.querySelector('#icon-grid2battery').classList.contains('active'), 'Grid2Battery arrow icon should be active');
        // assert.isTrue(card.shadowRoot.querySelector('#icon-battery2home').classList.contains('inactive'), 'Battery2Home arrow icon should be inactive');
        done();
      });
    });

  });
</script>
</body>
</html>
